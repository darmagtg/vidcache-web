#!/usr/bin/php
<?php
require(__DIR__.'/boot.php');

use \Vidcache\Admin\Client;
use \Vidcache\Admin\Client\File as ClientFile;
use \Vidcache\Admin\Client\Folder as ClientFolder;

//this script will add a file to a clients account
//	requires the following arguments
//	--client_id -- client_id to add to
//	--client_folder_id -- client folder to upload to
//	--file -- path to file (can be a URL)

$opts = getopt('',array('client_id:','client_folder_id:','file:'));

//validate client and folder
$client = Client::fetch($opts['client_id']);
if(!$client){
	dolog('Client doesnt exist',LOG_ERROR);
	exit;
}
$client_folder = ClientFolder::fetch($opts['client_folder_id']);
if(!$client_folder){
	dolog('Client folder does not exist',LOG_ERROR);
	exit;
}

//setup tmp file
$tmp_file = tempnam(sys_get_temp_dir(),'vc_');

//if the file is a url lets download it
if(strpos($opts['file'],'http') !== false){
	$dh = fopen($opts['file'],'r');
	$fh = fopen($tmp_file,'w');
	while(!feof($dh))
		fwrite($fh,fread($dh,1048576));
	fclose($dh);
	fclose($fh);
} else {
	//copy to temp file
	copy($opts['file'],$tmp_file);
}

chmod($tmp_file,0664);

//have the system upload the file
try {
	$client_file_id = ClientFile::upload(
		$client['client_id']
		,$client_folder['client_folder_id']
		,$tmp_file
		,basename($opts['file'])
	);
	if(file_exists($tmp_file)) unlink($tmp_file);
	dolog('File uploaded successfully: '.$client_file_id);
} catch(Exception $e){
	if(file_exists($tmp_file)) unlink($tmp_file);
	dolog('Failed to import file: '.$e->getMessage(),LOG_ERROR);
}
